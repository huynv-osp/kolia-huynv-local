# SA Analysis v2.16: Update Pending Invite Permissions API

> **Feature:** KOLIA-1517 - K·∫øt n·ªëi Ng∆∞·ªùi th√¢n  
> **Revision:** v2.16  
> **Date:** 2026-02-02  
> **Author:** SA Agent  
> **Status:** Ready for Review

---

## 1. Overview

### 1.1 Problem Statement

Hi·ªán t·∫°i, h·ªá th·ªëng kh√¥ng h·ªó tr·ª£ **ch·ªânh s·ª≠a quy·ªÅn** (permissions) c·ªßa l·ªùi m·ªùi ƒë√£ g·ª≠i ƒëi khi l·ªùi m·ªùi ƒëang ·ªü tr·∫°ng th√°i **pending** (status = 0). 

User g·ª≠i l·ªùi m·ªùi mu·ªën thay ƒë·ªïi permissions ƒë√£ c·∫•u h√¨nh th√¨ ch·ªâ c√≥ th·ªÉ:
- ‚ùå H·ªßy l·ªùi m·ªùi ‚Üí G·ª≠i l·∫°i l·ªùi m·ªùi m·ªõi v·ªõi permissions kh√°c (UX k√©m)
- ‚ùå G·ªçi API kh√¥ng t·ªìn t·∫°i ‚Üí 404 Error

### 1.2 Proposed Solution

Th√™m API m·ªõi cho ph√©p **sender** c·∫≠p nh·∫≠t permissions c·ªßa pending invite **tr∆∞·ªõc khi receiver ch·∫•p nh·∫≠n**.

| API | Method | Path |
|-----|:------:|------|
| **NEW** | PUT | `/api/v1/connections/invites/{inviteId}/permissions` |

### 1.3 Business Rules

| BR-ID | Description | Priority |
|-------|-------------|:--------:|
| **BR-031** | Ch·ªâ **sender** c·ªßa invite m·ªõi ƒë∆∞·ª£c s·ª≠a permissions | P0 |
| **BR-032** | Ch·ªâ √°p d·ª•ng cho invite c√≥ status = `0` (pending) | P0 |
| **BR-033** | Permissions ƒë∆∞·ª£c c·∫≠p nh·∫≠t trong `connection_invites.initial_permissions` | P0 |
| **BR-034** | Kh√¥ng g·ª≠i notification ƒë·∫øn receiver khi thay ƒë·ªïi permissions | P1 |

---

## 2. Impact Level: üü¢ LOW

| Criteria | Assessment |
|----------|------------|
| Services Affected | 2 (api-gateway, user-service) |
| Tables Modified | 1 (connection_invites - UPDATE only) |
| Breaking Changes | None |
| Proto Changes | 1 new rpc method |

---

## 3. REST API Specification

### PUT /api/v1/connections/invites/{inviteId}/permissions

> **Purpose:** Sender c·∫≠p nh·∫≠t permissions c·ªßa pending invite

**Path Parameters:**
| Param | Type | Required | Description |
|-------|------|:--------:|-------------|
| `inviteId` | UUID | ‚úÖ | ID c·ªßa invite c·∫ßn c·∫≠p nh·∫≠t |

**Request Body:**
```json
{
  "permissions": {
    "health_overview": true,
    "emergency_alert": true,
    "task_config": false,
    "compliance_tracking": true,
    "proxy_execution": false,
    "encouragement": true
  }
}
```

**Response (200 - Success):**
```json
{
  "invite_id": "uuid",
  "permissions": [
    { "code": "health_overview", "is_enabled": true },
    { "code": "emergency_alert", "is_enabled": true },
    { "code": "task_config", "is_enabled": false },
    { "code": "compliance_tracking", "is_enabled": true },
    { "code": "proxy_execution", "is_enabled": false },
    { "code": "encouragement", "is_enabled": true }
  ],
  "updated_at": "2026-02-02T10:00:00Z"
}
```

**Error Responses:**

| Status | Code | Description |
|:------:|------|-------------|
| 400 | `INVALID_PERMISSION_TYPE` | Permission code kh√¥ng h·ª£p l·ªá |
| 403 | `NOT_AUTHORIZED` | User kh√¥ng ph·∫£i sender c·ªßa invite |
| 404 | `INVITE_NOT_FOUND` | Invite kh√¥ng t·ªìn t·∫°i |
| 409 | `INVITE_NOT_PENDING` | Invite kh√¥ng ·ªü tr·∫°ng th√°i pending |

**Error Response Example:**
```json
{
  "error": {
    "code": "INVITE_NOT_PENDING",
    "message": "Ch·ªâ c√≥ th·ªÉ c·∫≠p nh·∫≠t quy·ªÅn cho l·ªùi m·ªùi ƒëang ch·ªù ph·∫£n h·ªìi"
  }
}
```

---

## 4. gRPC API Specification

### 4.1 Proto Changes (connection_service.proto)

```protobuf
// user-service/src/main/proto/user/connection_service.proto

service ConnectionService {
  // ... existing methods ...
  
  // NEW - v2.16
  rpc UpdatePendingInvitePermissions(UpdatePendingInvitePermissionsRequest) 
    returns (UpdatePendingInvitePermissionsResponse);
}

// NEW - v2.16
message UpdatePendingInvitePermissionsRequest {
  string user_id = 1;          // Sender's user_id (from JWT)
  string invite_id = 2;        // Target invite ID
  map<string, bool> permissions = 3;  // permission_code -> is_enabled
}

message UpdatePendingInvitePermissionsResponse {
  string invite_id = 1;
  repeated PermissionState permissions = 2;
  string updated_at = 3;
}

message PermissionState {
  string code = 1;
  bool is_enabled = 2;
}
```

---

## 5. Service-Level Changes

### 5.1 api-gateway-service (üü¢ LOW Impact)

| Layer | File | Type | Description |
|-------|------|:----:|-------------|
| Handler | `handler/InviteHandler.java` | MODIFY | Add `updatePendingInvitePermissions()` method |
| DTO | `dto/request/UpdateInvitePermissionsRequest.java` | NEW | Request DTO with permissions map |
| DTO | `dto/response/UpdateInvitePermissionsResponse.java` | NEW | Response DTO |
| Proto Client | Uses existing `ConnectionServiceGrpc` | - | Call new rpc method |
| Swagger | `docs/swagger/connection-management.yaml` | MODIFY | Add new endpoint |

**Handler Implementation:**
```java
// InviteHandler.java
public void updatePendingInvitePermissions(RoutingContext ctx) {
    String inviteId = ctx.pathParam("inviteId");
    UpdateInvitePermissionsRequest request = ctx.body().asPojo(UpdateInvitePermissionsRequest.class);
    
    UpdatePendingInvitePermissionsRequest grpcRequest = UpdatePendingInvitePermissionsRequest.newBuilder()
        .setUserId(getUserIdFromContext(ctx))
        .setInviteId(inviteId)
        .putAllPermissions(request.getPermissions())
        .build();
    
    connectionServiceClient.updatePendingInvitePermissions(grpcRequest)
        .onSuccess(response -> {
            ctx.response()
                .putHeader("Content-Type", "application/json")
                .setStatusCode(200)
                .end(Json.encode(mapToResponse(response)));
        })
        .onFailure(error -> handleGrpcError(ctx, error));
}
```

**Estimated Effort:** 2 hours

---

### 5.2 user-service (üü¢ LOW Impact)

| Layer | File | Type | Description |
|-------|------|:----:|-------------|
| Proto | `proto/user/connection_service.proto` | MODIFY | Add new rpc + messages |
| gRPC Impl | `grpc/ConnectionServiceGrpcImpl.java` | MODIFY | Implement `updatePendingInvitePermissions` |
| Service | `service/InviteService.java` | MODIFY | Add `updatePermissions()` method |
| Repository | `repository/InviteRepository.java` | MODIFY | Add `updateInitialPermissions()` |

**Service Implementation:**
```java
// InviteServiceImpl.java
public Future<UpdatePendingInvitePermissionsResponse> updatePermissions(
    String userId, String inviteId, Map<String, Boolean> permissions) {
    
    return inviteRepository.findById(inviteId)
        .compose(invite -> {
            // Validate sender
            if (!invite.getSenderId().equals(userId)) {
                return Future.failedFuture(new NotAuthorizedException("NOT_AUTHORIZED"));
            }
            
            // Validate status = 0 (pending)
            if (invite.getStatus() != 0) {
                return Future.failedFuture(new ConflictException("INVITE_NOT_PENDING"));
            }
            
            // Validate permission codes
            return validatePermissionCodes(permissions.keySet())
                .compose(valid -> {
                    JsonObject newPermissions = buildPermissionsJson(permissions);
                    return inviteRepository.updateInitialPermissions(inviteId, newPermissions);
                });
        })
        .map(updated -> buildResponse(updated));
}
```

**Repository Implementation:**
```java
// InviteRepository.java
public Future<ConnectionInvite> updateInitialPermissions(String inviteId, JsonObject permissions) {
    String sql = """
        UPDATE connection_invites 
        SET initial_permissions = $1::jsonb, updated_at = NOW()
        WHERE invite_id = $2 AND status = 0
        RETURNING *
        """;
    
    return pgPool.preparedQuery(sql)
        .execute(Tuple.of(permissions.encode(), UUID.fromString(inviteId)))
        .map(rows -> mapToEntity(rows.iterator().next()));
}
```

**Estimated Effort:** 3 hours

---

## 6. Database Impact

### 6.1 Table: connection_invites

**No schema changes required.** Column `initial_permissions` (JSONB) ƒë√£ t·ªìn t·∫°i v√† ƒë·ªß ƒë·ªÉ l∆∞u permissions.

**SQL Operation:**
```sql
-- Update permissions for pending invite
UPDATE connection_invites 
SET initial_permissions = '{"health_overview":true,"emergency_alert":true,...}'::jsonb,
    updated_at = NOW()
WHERE invite_id = '{invite_id}' 
  AND sender_id = '{user_id}' 
  AND status = 0;
```

---

## 7. Swagger Update

### 7.1 connection-management.yaml

```yaml
# Add to paths section
/api/v1/connections/invites/{inviteId}/permissions:
  put:
    tags:
      - Invite Management
    summary: Update pending invite permissions
    description: |
      Sender c√≥ th·ªÉ c·∫≠p nh·∫≠t permissions c·ªßa l·ªùi m·ªùi ƒëang ·ªü tr·∫°ng th√°i pending (status=0).
      
      **Business Rules:**
      - BR-031: Ch·ªâ sender c·ªßa invite m·ªõi ƒë∆∞·ª£c s·ª≠a
      - BR-032: Ch·ªâ √°p d·ª•ng cho invite status = 0 (pending)
      - BR-034: Kh√¥ng g·ª≠i notification ƒë·∫øn receiver
    operationId: updatePendingInvitePermissions
    security:
      - BearerAuth: []
    parameters:
      - name: inviteId
        in: path
        required: true
        schema:
          type: string
          format: uuid
        description: ID c·ªßa invite c·∫ßn c·∫≠p nh·∫≠t
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/UpdateInvitePermissionsRequest'
    responses:
      '200':
        description: Permissions updated successfully
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateInvitePermissionsResponse'
      '400':
        description: Invalid permission type
      '403':
        description: Not authorized (not the sender)
      '404':
        description: Invite not found
      '409':
        description: Invite is not in pending status

# Add to components/schemas
UpdateInvitePermissionsRequest:
  type: object
  required:
    - permissions
  properties:
    permissions:
      type: object
      additionalProperties:
        type: boolean
      example:
        health_overview: true
        emergency_alert: true
        task_config: false
        compliance_tracking: true
        proxy_execution: false
        encouragement: true

UpdateInvitePermissionsResponse:
  type: object
  properties:
    invite_id:
      type: string
      format: uuid
    permissions:
      type: array
      items:
        $ref: '#/components/schemas/PermissionState'
    updated_at:
      type: string
      format: date-time

PermissionState:
  type: object
  properties:
    code:
      type: string
      example: health_overview
    is_enabled:
      type: boolean
```

---

## 8. Verification Plan

### 8.1 Unit Tests

```java
// InviteServiceTest.java

@Test
void updatePermissions_Success() {
    // Given: sender with pending invite
    // When: updatePermissions called
    // Then: permissions updated, return new values
}

@Test
void updatePermissions_NotSender_ThrowsForbidden() {
    // Given: user is NOT the sender
    // When: updatePermissions called
    // Then: throw NotAuthorizedException
}

@Test
void updatePermissions_NotPending_ThrowsConflict() {
    // Given: invite status = 1 (accepted) 
    // When: updatePermissions called
    // Then: throw ConflictException("INVITE_NOT_PENDING")
}

@Test
void updatePermissions_InvalidPermissionCode_ThrowsBadRequest() {
    // Given: request with invalid permission code
    // When: updatePermissions called
    // Then: throw BadRequestException("INVALID_PERMISSION_TYPE")
}
```

### 8.2 Integration Test

```bash
# Test flow
curl -X PUT http://localhost:8080/api/v1/connections/invites/{inviteId}/permissions \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{
    "permissions": {
      "health_overview": true,
      "emergency_alert": false,
      "task_config": true
    }
  }'
```

### 8.3 Manual Test

1. ƒêƒÉng nh·∫≠p app v·ªõi t∆∞ c√°ch Patient
2. G·ª≠i l·ªùi m·ªùi cho Caregiver v·ªõi permissions m·∫∑c ƒë·ªãnh
3. Tr·ªü v·ªÅ m√†n h√¨nh chi ti·∫øt pending invite
4. Nh·∫•n Settings ‚Üí Thay ƒë·ªïi m·ªôt s·ªë permissions
5. Nh·∫•n Save ‚Üí Confirm toast "ƒê√£ c·∫≠p nh·∫≠t quy·ªÅn th√†nh c√¥ng"
6. Reload trang ‚Üí Permissions ph·∫£i ƒë∆∞·ª£c gi·ªØ nguy√™n

---

## 9. Implementation Checklist

- [ ] **user-service**
  - [ ] Update `connection_service.proto` - add new rpc method
  - [ ] Implement `ConnectionServiceGrpcImpl.updatePendingInvitePermissions()`
  - [ ] Implement `InviteService.updatePermissions()`
  - [ ] Add repository method `updateInitialPermissions()`
  - [ ] Unit tests

- [ ] **api-gateway-service**
  - [ ] Sync updated proto file
  - [ ] Add handler method `updatePendingInvitePermissions()`
  - [ ] Create request/response DTOs
  - [ ] Register route in `InviteVerticle`
  - [ ] Update Swagger documentation

- [ ] **app-mobile-ai**
  - [ ] Update `connection.service.ts` - use correct endpoint
  - [ ] Remove 404 error handling workaround

---

## 10. Revision History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| v2.16 | 2026-02-02 | SA Agent | Initial - Add Update Pending Invite Permissions API |
