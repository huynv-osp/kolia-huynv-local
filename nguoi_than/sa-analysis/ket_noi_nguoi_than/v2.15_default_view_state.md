# SA Analysis: v2.15 - Default View State (Option E)

> **Date:** 2026-02-02  
> **SRS Reference:** SRS v3.0 - B.4.3b, B.4.3c, B.4.3d (Lines 699-755)  
> **Parent Document:** `api_mapping.md` v2.13  
> **Feature:** Default View State logic when Caregiver has not selected a Patient

---

## 1. Executive Summary

### Y√™u c·∫ßu
ƒê·ªãnh nghƒ©a behavior khi Caregiver ch∆∞a ch·ªçn Patient ƒë·ªÉ xem (selectedPatient = null) nh∆∞ng v·∫´n c√≥ connections trong danh s√°ch "T√¥i ƒëang theo d√µi".

### Context
- **Before (v2.14):** Auto-select Patient ƒë·∫ßu ti√™n khi v√†o trang
- **After (v2.15 - Option E):** Hi·ªÉn th·ªã "Default View Prompt" thay v√¨ auto-select

### Feasibility Score: 98/100 (Highly Feasible)

- **Architecture Fit:** 100% - Ch·ªß y·∫øu l√† frontend logic
- **API Changes:** 95% - Minimal (clarify null response)
- **Backend Impact:** 100% - No changes required
- **Mobile Impact:** 90% - UI state management updates

---

## 2. UX-DVS Rules Specification

> **Source:** SRS v3.0 - K·ªãch b·∫£n B.4.3b, B.4.3c, B.4.3d

### 2.1 UX Rules Table

| Rule-ID | Category | M√¥ t·∫£ | Priority |
|---------|----------|-------|:--------:|
| **UX-DVS-001** | First Load | Khi page load l·∫ßn ƒë·∫ßu (kh√¥ng c√≥ localStorage), hi·ªÉn th·ªã Default View Prompt thay v√¨ auto-select Patient | P0 |
| **UX-DVS-002** | CTA Action | CTA "Xem danh s√°ch ng∆∞·ªùi th√¢n" g·ªçi `toggleBottomSheet()` ƒë·ªÉ m·ªü profile list | P0 |
| **UX-DVS-003** | Close Sheet | Khi ƒë√≥ng Bottom Sheet, call `updateStopFollowUI(selectedPatient)` ƒë·ªÉ refresh UI state | P0 |
| **UX-DVS-004** | Stop Follow Link | Link "Ng·ª´ng theo d√µi" ch·ªâ hi·ªán khi c√≥ Patient ƒë∆∞·ª£c ch·ªçn V√Ä kh√¥ng ·ªü Empty State | P0 |
| **UX-DVS-005** | Modal Validation | `showStopFollowModal()` ki·ªÉm tra selectedPatient tr∆∞·ªõc khi hi·ªán modal, toast n·∫øu null | P1 |

---

## 3. Scenarios

### 3.1 K·ªãch b·∫£n B4.3b: Default View State - Khi ch∆∞a ch·ªçn Patient

> **Context:** √Åp d·ª•ng khi `selectedPatient = null` nh∆∞ng `followingCount > 0`

```gherkin
Given Caregiver ƒëang ·ªü SCR-01
  And selectedPatient = null
  And Caregiver ƒëang theo d√µi √≠t nh·∫•t 1 Patient
When M√†n h√¨nh load xong
Then Hi·ªÉn th·ªã "Default View Prompt" g·ªìm:
  | Element | Chi ti·∫øt |
  | Icon | üëã (48px) |
  | Title | "Ch·ªçn ng∆∞·ªùi th√¢n ƒë·ªÉ b·∫Øt ƒë·∫ßu" |
  | Subtitle | "Nh·∫•n n√∫t b√™n d∆∞·ªõi ƒë·ªÉ ch·ªçn ng∆∞·ªùi b·∫°n mu·ªën theo d√µi" |
  | CTA Button | "üìã Xem danh s√°ch ng∆∞·ªùi th√¢n" ‚Üí toggleBottomSheet() |

When Caregiver nh·∫•n CTA "Xem danh s√°ch ng∆∞·ªùi th√¢n"
Then toggleBottomSheet() ‚Üí M·ªü Bottom Sheet "Danh s√°ch k·∫øt n·ªëi"
  And Caregiver c√≥ th·ªÉ ch·ªçn Patient t·ª´ list "T√¥i ƒëang theo d√µi"
  Ref: UX-DVS-001, UX-DVS-002
```

### 3.2 K·ªãch b·∫£n B4.3c: ƒê√≥ng Bottom Sheet m√† kh√¥ng ch·ªçn Patient

```gherkin
Given Caregiver ƒë√£ m·ªü Bottom Sheet "Danh s√°ch k·∫øt n·ªëi"
  And selectedPatient = null
When Caregiver ƒë√≥ng Bottom Sheet (tap overlay ho·∫∑c button X)
Then hideBottomSheet()
  And Call updateStopFollowUI(selectedPatient) ƒë·ªÉ refresh UI
  And "Default View Prompt" v·∫´n hi·ªÉn th·ªã
  And Link "Ng·ª´ng theo d√µi" ·∫®N (v√¨ ch∆∞a ch·ªçn Patient)
  Ref: UX-DVS-003
```

### 3.3 K·ªãch b·∫£n B4.3d: Visibility c·ªßa Link "Ng·ª´ng theo d√µi"

```gherkin
Given Caregiver ƒëang ·ªü SCR-01
Then Link "Ng·ª´ng theo d√µi" hi·ªÉn th·ªã theo ƒëi·ªÅu ki·ªán:
  | ƒêi·ªÅu ki·ªán | Hi·ªÉn th·ªã Link |
  | selectedPatient = null | ‚ùå ·∫®N |
  | selectedPatient != null AND emptyState = visible | ‚ùå ·∫®N |
  | selectedPatient != null AND emptyState = hidden | ‚úÖ HI·ªÜN |
  Ref: UX-DVS-004
```

---

## 4. API Behavior Clarification

### 4.1 GET /api/v1/connections/viewing - Null Response

> **Existing API:** ƒê√£ document trong `api_mapping.md` v2.7

**Scenario: No Patient Selected**

```json
// Request
GET /api/v1/connections/viewing
Authorization: Bearer {caregiver_token}

// Response (200 - No Selection)
{
  "viewing_patient": null
}
```

**Frontend Handling:**
1. Check `viewing_patient === null`
2. Check if `monitoring.length > 0` (c√≥ Patient ƒë·ªÉ ch·ªçn)
3. If both true ‚Üí Render Default View Prompt (UX-DVS-001)
4. If `monitoring.length === 0` ‚Üí Render Empty State (BR-015)

### 4.2 DELETE /api/v1/connections/{id} - Side Effects Update

> **Enhancement:** Clear viewing state khi disconnect

**Additional Side Effects (v2.15):**
```
When connection b·ªã disconnect:
1. Set is_viewing = FALSE cho row ƒë√≥
2. Return viewing_patient = null trong response (n·∫øu patient ƒëang ƒë∆∞·ª£c ch·ªçn)
3. Client MUST:
   - Set selectedPatient = null
   - localStorage.removeItem('selectedPatient')
   - Navigate v·ªÅ SCR-01
   - Show Default View Prompt
```

---

## 5. State Management (Mobile)

### 5.1 State Flow Diagram

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   DEFAULT VIEW STATE FLOW                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                  ‚îÇ
‚îÇ  PAGE LOAD                                                       ‚îÇ
‚îÇ      ‚îÇ                                                           ‚îÇ
‚îÇ      ‚ñº                                                           ‚îÇ
‚îÇ  Check localStorage.selectedPatient                              ‚îÇ
‚îÇ      ‚îÇ                                                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                       ‚îÇ
‚îÇ  ‚îÇ EXISTS                               ‚îÇ NULL                   ‚îÇ
‚îÇ  ‚ñº                                       ‚ñº                       ‚îÇ
‚îÇ  Validate connection                  Check followingCount       ‚îÇ
‚îÇ  still active?                            ‚îÇ                      ‚îÇ
‚îÇ      ‚îÇ                                ‚îå‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                          ‚îÇ > 0           ‚îÇ = 0      ‚îÇ
‚îÇ  ‚îÇ YES     ‚îÇ NO                       ‚ñº               ‚ñº          ‚îÇ
‚îÇ  ‚ñº         ‚ñº                     Show Default    Show Empty      ‚îÇ
‚îÇ  Load    Clear + Show              View Prompt    State          ‚îÇ
‚îÇ  Dashboard  Default View           (UX-DVS-001)   (BR-015)       ‚îÇ
‚îÇ              Prompt                                              ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 5.2 localStorage Keys

| Key | Type | Description |
|-----|------|-------------|
| `selectedPatient` | string (UUID) | ID c·ªßa Patient ƒëang ƒë∆∞·ª£c ch·ªçn |
| `selectedConnection` | string (UUID) | ID c·ªßa connection (for validation) |

### 5.3 State Transitions

| Trigger | From State | To State | Action |
|---------|------------|----------|--------|
| Page load (no localStorage) | - | Default View | Show prompt |
| Select Patient from list | Default View | Dashboard | Save to localStorage |
| Stop following selected | Dashboard | Default View | Clear localStorage |
| Connection disconnected by Patient | Dashboard | Default View | Toast + Clear |
| Last connection removed | Default View | Empty State | Show empty CTA |

---

## 6. Impact Analysis

### 6.1 Service Impact

| Service | Impact Level | Changes Required |
|---------|:------------:|------------------|
| **user-service** | ‚úÖ NONE | No backend changes |
| **api-gateway-service** | ‚úÖ NONE | No API changes |
| **Mobile App** | üü° MEDIUM | State management + UI updates |

### 6.2 Mobile Changes Required

| Layer | File | Change |
|-------|------|--------|
| Screen | `ConnectRelativesScreen.tsx` | Add Default View Prompt component |
| Hook | `useViewingPatient.ts` | Handle null state properly |
| Component | `ProfileSelector.tsx` | Support null selectedPatient |
| Component | `StopFollowingLink.tsx` | Add visibility logic (UX-DVS-004) |
| Storage | `localStorage` | Clear on disconnect |

### 6.3 Estimated Effort

| Task | Hours | Priority |
|------|:-----:|:--------:|
| Default View Prompt UI | 2 | HIGH |
| State management updates | 2 | HIGH |
| Stop Follow link visibility | 1 | HIGH |
| Disconnect side effects | 1 | HIGH |
| Unit tests | 1 | MEDIUM |
| **TOTAL** | **7** | |

---

## 7. Test Scenarios

### 7.1 Manual Test Cases

| # | Scenario | Expected Result |
|:-:|----------|-----------------|
| 1 | First visit, no localStorage | Default View Prompt shown |
| 2 | Tap CTA button | Bottom Sheet opens |
| 3 | Select Patient from list | Dashboard loads, localStorage saved |
| 4 | Stop following selected Patient | Return to Default View Prompt |
| 5 | Close Bottom Sheet without selecting | Default View Prompt remains |
| 6 | Stop Follow link when null | Link not visible |
| 7 | Stop Follow link when selected | Link visible |

### 7.2 Edge Cases

| Case | Handling |
|------|----------|
| localStorage has invalid connection ID | Validate ‚Üí Clear ‚Üí Show Default View |
| Patient disconnects while viewing | Toast + Clear ‚Üí Default View |
| All connections removed | Transition to Empty State |

---

## 8. Implementation Checklist

- [ ] **Mobile: ConnectRelativesScreen.tsx**
  - Add `DefaultViewPrompt` component
  - Handle `viewing_patient === null` && `monitoring.length > 0`

- [ ] **Mobile: StopFollowingLink.tsx**
  - Add condition: `selectedPatient !== null && !emptyState`

- [ ] **Mobile: useViewingPatient.ts**
  - Update disconnect handler to clear localStorage
  - Add `updateStopFollowUI` callback

- [ ] **Mobile: ProfileSelector.tsx**
  - Support null state display

- [ ] **Tests**
  - Unit tests for state transitions
  - E2E test for full flow

---

## 9. Backward Compatibility

| Aspect | Status |
|--------|:------:|
| API contracts | ‚úÖ No changes |
| Database schema | ‚úÖ No changes |
| Existing connections | ‚úÖ Not affected |
| localStorage migration | ‚ö†Ô∏è Clear on first load if invalid |

---

## 10. Approval

> **Recommendation:** ‚úÖ PROCEED - Low risk, improves UX clarity

| Approver | Status | Date |
|----------|:------:|------|
| SA Review | ‚úÖ | 2026-02-02 |
| Tech Lead | ‚è≥ | - |
