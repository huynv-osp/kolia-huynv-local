# SA Analysis: v2.14 - Mark Report as Read API

> **Date:** 2026-01-30  
> **SRS Reference:** BR-RPT-001 (Report Read Tracking)  
> **Parent Document:** `api_mapping.md` v2.13  
> **Request:** Add API endpoint for Caregiver to mark patient report as read

---

## 1. Executive Summary

### YÃªu cáº§u
ThÃªm API endpoint cho phÃ©p **Caregiver** Ä‘Ã¡nh dáº¥u **Ä‘Ã£ xem** bÃ¡o cÃ¡o sá»©c khá»e cá»§a Patient Ä‘ang theo dÃµi.

### Hiá»‡n tráº¡ng

| Component | Status | Location |
|-----------|:------:|----------|
| Database Table | âœ… EXISTS | `caregiver_report_views` |
| Service Method | âœ… EXISTS | `DashboardServiceImpl.markReportAsRead()` |
| gRPC Proto | âŒ MISSING | `connection_service.proto` |
| gRPC Handler | âŒ MISSING | `ConnectionServiceGrpcImpl.java` |
| API Gateway | âŒ MISSING | `DashboardHandler.java` |
| Swagger Docs | âŒ MISSING | `dashboard-management.yaml` |

### Feasibility Score: 95/100 (Highly Feasible)

- **Architecture Fit:** 100% - Follows existing Dashboard API pattern
- **Database Ready:** 100% - Table already exists with proper indexes
- **Service Ready:** 100% - Business logic already implemented
- **Integration:** 90% - Standard gRPC + REST pattern, minimal new code

---

## 2. API Specification

### 2.1 REST Endpoint

```
POST /api/v1/patients/:patientId/periodic-reports/:reportId/mark-read
```

| Component | Value |
|-----------|-------|
| **Method** | POST |
| **Path** | `/api/v1/patients/{patientId}/periodic-reports/{reportId}/mark-read` |
| **Authorization** | Bearer Token (Caregiver) |
| **Permission Check** | SEC-DB-001 (`health_overview` permission) |

**Path Parameters:**
| Param | Type | Description |
|-------|------|-------------|
| `patientId` | UUID | ID cá»§a Patient Ä‘Æ°á»£c theo dÃµi |
| `reportId` | Long | ID cá»§a bÃ¡o cÃ¡o cáº§n Ä‘Ã¡nh dáº¥u Ä‘Ã£ Ä‘á»c |

**Request Body:** Empty (no body required)

**Response (200 - Success):**
```json
{
  "status": 200,
  "message": "Report marked as read",
  "data": {
    "report_id": 1001,
    "marked_at": "2026-01-30T23:15:00Z"
  }
}
```

**Error Responses:**
| Code | Error | Condition |
|:----:|-------|-----------|
| 403 | NOT_CONNECTED | Caregiver khÃ´ng cÃ³ káº¿t ná»‘i vá»›i Patient |
| 403 | PERMISSION_DENIED | Permission `health_overview` = OFF |
| 404 | REPORT_NOT_FOUND | BÃ¡o cÃ¡o khÃ´ng tá»“n táº¡i hoáº·c khÃ´ng thuá»™c Patient |

---

### 2.2 gRPC Definition

```protobuf
// Add to connection_service.proto

// Dashboard APIs (v2.14)
rpc MarkReportAsRead(MarkReportAsReadRequest) returns (MarkReportAsReadResponse);

message MarkReportAsReadRequest {
  string caregiver_id = 1;
  string patient_id = 2;
  int64 report_id = 3;
}

message MarkReportAsReadResponse {
  int64 report_id = 1;
  string marked_at = 2;
}
```

---

### 2.3 Data Processing Logic (Chi tiáº¿t xá»­ lÃ½ Backend)

#### Business Logic Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 MARK REPORT AS READ - DATA FLOW                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1. INPUT VALIDATION                                             â”‚
â”‚  â”œâ”€â”€ caregiver_id: UUID format check                             â”‚
â”‚  â”œâ”€â”€ patient_id: UUID format check                               â”‚
â”‚  â””â”€â”€ report_id: Long > 0                                         â”‚
â”‚                                                                  â”‚
â”‚  2. AUTHORIZATION (SEC-DB-001) - Reuse existing method           â”‚
â”‚  â””â”€â”€ Call: dashboardService.validateCaregiverAccess()            â”‚
â”‚      â”œâ”€â”€ Check: connection exists                                â”‚
â”‚      â””â”€â”€ Check: permission 'health_overview' enabled             â”‚
â”‚                                                                  â”‚
â”‚  3. REPORT OWNERSHIP VALIDATION                                  â”‚
â”‚  â””â”€â”€ Query: SELECT 1 FROM report_periodic                        â”‚
â”‚             WHERE report_id = ? AND user_id = patient_id         â”‚
â”‚                                                                  â”‚
â”‚  4. INSERT READ RECORD (Idempotent)                              â”‚
â”‚  â””â”€â”€ Query: INSERT ... ON CONFLICT DO NOTHING                    â”‚
â”‚                                                                  â”‚
â”‚  5. RETURN RESPONSE                                              â”‚
â”‚  â””â”€â”€ { report_id, marked_at: NOW() }                             â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### SQL Queries

**Step 2: Authorization (Reuse existing)**
```sql
-- Already implemented in DashboardServiceImpl.validateCaregiverAccess()
SELECT cp.is_enabled 
FROM user_emergency_contacts uec
JOIN connection_permissions cp ON cp.contact_id = uec.id
WHERE uec.user_id = :patient_id
  AND uec.linked_user_id = :caregiver_id
  AND uec.contact_type = 'caregiver'
  AND uec.is_active = TRUE
  AND cp.permission_code = 'health_overview'
  AND cp.is_enabled = TRUE;
```

**Step 3: Report Ownership Validation (NEW)**
```sql
-- Verify report belongs to the patient being monitored
SELECT 1 FROM report_periodic
WHERE report_id = :report_id
  AND user_id = :patient_id
  AND status = 1;  -- Active report only
```

**Step 4: Insert Read Record (EXISTING)**
```sql
-- Already implemented in DashboardServiceImpl.markReportAsRead()
INSERT INTO caregiver_report_views (caregiver_id, report_id)
VALUES (:caregiver_id, :report_id)
ON CONFLICT (caregiver_id, report_id) DO NOTHING;
```

#### Edge Cases & Business Rules

| Case | Handling | Response |
|------|----------|----------|
| Caregiver khÃ´ng cÃ³ connection | Reject | 403 NOT_CONNECTED |
| Permission `health_overview` OFF | Reject | 403 PERMISSION_DENIED |
| Report khÃ´ng thuá»™c Patient | Reject | 404 REPORT_NOT_FOUND |
| Report Ä‘Ã£ Ä‘Æ°á»£c Ä‘Ã¡nh dáº¥u rá»“i | Idempotent | 200 Success (no error) |
| Connection bá»‹ disconnect giá»¯a chá»«ng | Auth check fail | 403 NOT_CONNECTED |

#### Side Effects

| Effect | Description |
|--------|-------------|
| `caregiver_report_views` | Insert new row (or no-op if exists) |
| `is_read` field | Next GET call returns `is_read: true` |
| `unread_count` | Decremented by 1 in list response |

#### Timing Behavior

- **Trigger:** When caregiver opens report detail screen (not list)
- **Frontend:** Call API sau khi hiá»ƒn thá»‹ report detail (debounce náº¿u cáº§n)
- **Idempotent:** Multiple calls = same result (safe retry)

---

## 3. Authorization Flow Summary (SEC-DB-001)

> Authorization flow uses existing `validateCaregiverAccess()` + new report ownership check. See Section 2.3 for detailed SQL queries.

---

## 4. Impact Analysis

### 4.1 Service Impact

| Service | Impact Level | Changes Required |
|---------|:------------:|------------------|
| **user-service** | ðŸŸ¢ LOW | Add gRPC handler (existing service method) |
| **api-gateway-service** | ðŸŸ¢ LOW | Add REST handler + gRPC client call |
| **Database** | âœ… NONE | Table already exists |

### 4.2 Detailed Changes

#### user-service (ðŸŸ¢ LOW)

| Layer | File | Change Type | Description |
|-------|------|:-----------:|-------------|
| Proto | `connection_service.proto` | MODIFY | Add `MarkReportAsRead` rpc |
| gRPC Handler | `ConnectionServiceGrpcImpl.java` | MODIFY | Add handler method |
| Service | `DashboardServiceImpl.java` | âœ… EXISTS | Already implemented |

#### api-gateway-service (ðŸŸ¢ LOW)

| Layer | File | Change Type | Description |
|-------|------|:-----------:|-------------|
| Handler | `DashboardHandler.java` | MODIFY | Add `markReportAsRead` handler |
| Client | Uses existing gRPC client | - | No changes needed |
| Swagger | `dashboard-management.yaml` | MODIFY | Add endpoint documentation |

---

## 5. Effort Estimate

| Task | Hours | Priority |
|------|:-----:|:--------:|
| Proto definition update | 0.5 | HIGH |
| gRPC handler (user-service) | 1 | HIGH |
| API Gateway handler | 1 | HIGH |
| Swagger documentation | 0.5 | MEDIUM |
| Unit tests | 1 | MEDIUM |
| Integration test | 0.5 | LOW |
| **TOTAL** | **4.5** | |

---

## 6. Risks & Mitigations

| Risk | Severity | Mitigation |
|------|:--------:|------------|
| Report khÃ´ng thuá»™c Patient | LOW | Validate report ownership before marking |
| Duplicate marking | NONE | `ON CONFLICT DO NOTHING` (idempotent) |
| Permission check bypass | MEDIUM | Reuse existing SEC-DB-001 pattern |

---

## 7. Implementation Checklist

- [ ] **user-service/proto/connection_service.proto**
  - Add `MarkReportAsRead` rpc
  - Add request/response messages

- [ ] **user-service/grpc/ConnectionServiceGrpcImpl.java**
  - Add `markReportAsRead` handler method
  - Implement SEC-DB-001 authorization
  - Add report ownership validation
  - Call `dashboardService.markReportAsRead()`

- [ ] **api-gateway-service/handler/DashboardHandler.java**
  - Add POST `/patients/:patientId/periodic-reports/:reportId/mark-read`
  - Call gRPC method

- [ ] **api-gateway-service/swagger/dashboard-management.yaml**
  - Document new endpoint

- [ ] **Tests**
  - Unit test for gRPC handler
  - Integration test for full flow

---

## 8. Approval

> **Recommendation:** âœ… PROCEED - Low risk, high benefit, builds on existing implementation

| Approver | Status | Date |
|----------|:------:|------|
| SA Review | PENDING | |
| Tech Lead | PENDING | |
