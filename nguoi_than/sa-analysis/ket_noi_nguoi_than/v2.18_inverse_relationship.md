# SA Analysis: v2.18 - Inverse Relationship Code

> **Date:** 2026-02-04  
> **Version:** v2.18  
> **Type:** Enhancement - Bidirectional Relationship Awareness  
> **Business Rule:** BR-035

---

## 1. Problem Statement

Hi·ªán t·∫°i `relationship_code` ch·ªâ l∆∞u **m·ªôt chi·ªÅu** (Sender m√¥ t·∫£ Receiver). ƒêi·ªÅu n√†y g√¢y ra v·∫•n ƒë·ªÅ semantic khi hi·ªÉn th·ªã m·ªëi quan h·ªá t·ª´ perspective kh√°c nhau.

### Issue Example

| `invite_type` | `relationship_code` | Problem |
|---------------|---------------------|---------|
| `add_caregiver` | Patient g·ªçi Caregiver l√† "Con trai" | ‚úÖ ƒê√∫ng khi Patient xem |
| `add_patient` | Caregiver g·ªçi Patient l√† "M·∫π" | ‚ùå Sai khi Patient xem danh s√°ch Caregiver |

---

## 2. Schema Changes

### 2.1 connection_invites

```sql
ALTER TABLE connection_invites 
ADD COLUMN IF NOT EXISTS inverse_relationship_code VARCHAR(30) 
    REFERENCES relationships(relationship_code);

COMMENT ON COLUMN connection_invites.relationship_code IS 'Sender m√¥ t·∫£ Receiver l√† [X]';
COMMENT ON COLUMN connection_invites.inverse_relationship_code IS 'Receiver m√¥ t·∫£ Sender l√† [X]';
```

### 2.2 user_emergency_contacts

```sql
ALTER TABLE user_emergency_contacts 
ADD COLUMN IF NOT EXISTS inverse_relationship_code VARCHAR(30) 
    REFERENCES relationships(relationship_code);

COMMENT ON COLUMN user_emergency_contacts.relationship_code IS 'Patient (user_id) m√¥ t·∫£ Caregiver (linked_user_id) l√† [X]';
COMMENT ON COLUMN user_emergency_contacts.inverse_relationship_code IS 'Caregiver (linked_user_id) m√¥ t·∫£ Patient (user_id) l√† [X]';
```

---

## 3. Semantic Definition

| Table | `relationship_code` | `inverse_relationship_code` |
|-------|--------------------|-----------------------------|
| `connection_invites` | Sender m√¥ t·∫£ Receiver | Receiver m√¥ t·∫£ Sender |
| `user_emergency_contacts` | Patient m√¥ t·∫£ Caregiver | Caregiver m√¥ t·∫£ Patient |

---

## 4. Mapping Logic (Accept Invite)

```java
// ConnectionFlowServiceImpl.insertNewConnection()

String relationshipCode;
String inverseRelationshipCode;

if ("add_caregiver".equals(invite.getInviteType())) {
    // Patient sent ‚Üí UEC perspective matches invite perspective
    relationshipCode = invite.getRelationshipCode();         // Patient g·ªçi Caregiver
    inverseRelationshipCode = invite.getInverseRelationshipCode(); // Caregiver g·ªçi Patient
} else { // add_patient
    // Caregiver sent ‚Üí SWAP for UEC perspective
    relationshipCode = invite.getInverseRelationshipCode();  // Patient g·ªçi Caregiver
    inverseRelationshipCode = invite.getRelationshipCode();  // Caregiver g·ªçi Patient
}
```

---

## 5. Impact Analysis

| Service | Impact | Changes |
|---------|:------:|---------|
| **user-service** | üü° MEDIUM | Entity + Service logic |
| **api-gateway-service** | üü¢ LOW | Proto sync only |
| **Mobile App** | üü¢ LOW | Display logic |

---

## 6. Verification

| Test Case | Expected Result |
|-----------|-----------------|
| Patient m·ªùi Caregiver (l√† "Con trai") | Patient th·∫•y "Con trai", Caregiver th·∫•y "M·∫π" |
| Caregiver m·ªùi Patient (l√† "M·∫π") | Patient th·∫•y "Con trai", Caregiver th·∫•y "M·∫π" |

---

## 7. Documents Updated

| Document | Version |
|----------|:-------:|
| `_update_db/3_database-nguoi_than.sql` | v2.13 |
| `features/.../database-changes.sql` | v2.13 |
| `features/.../feature-spec.md` | v2.18 |
| `features/.../implementation-plan.md` | v2.18 |
| `sa-analysis/.../04_mapping/database_mapping.md` | v2.13 |
| `sa-analysis/.../04_mapping/service_mapping.md` | v2.13 |
| `sa-analysis/.../08_report/complete_analysis.md` | v2.18 |
