# SA Analysis: v2.23 - Perspective Display Standard

> **Date:** 2026-02-04  
> **Version:** v2.23  
> **Type:** Bug Fix - Correct Perspective Display in UI  
> **Business Rule:** BR-036 (Bidirectional Relationship Display)

---

## 1. Problem Statement

C√°c fix t·ª´ v2.18 (`inverse_relationship_code`) ch·ªâ gi·∫£i quy·∫øt logic backend. UI v·∫´n s·ª≠ d·ª•ng sai field g√¢y **Perspective Display Bug**:

### Issue Example

| Screen | Field Used | Display | Expected |
|--------|-----------|---------|----------|
| Chi ti·∫øt k·∫øt n·ªëi (Caregiver xem Patient) | `relationship` | "Ch√°u" | "√îng" |
| C·∫£nh b√°o - Empty State | `relationship_name` | "Ch√°u (HuySau)" | "√îng (HuySau)" |
| Health Dashboard | `relationship_display` | "Ch√°u (HuySau)" | "√îng (HuySau)" |

> **Nguy√™n nh√¢n:** Frontend s·ª≠ d·ª•ng `relationship_*` fields (Caregiver perspective) thay v√¨ `inverse_relationship_*` fields (Patient perspective) khi Caregiver xem Patient.

---

## 2. Perspective Definition (Standard)

### v2.23 Finalized Standard

| Context | Viewer | Target | Correct Field |
|---------|--------|--------|---------------|
| **Caregiver xem Patient** | Caregiver | Patient | `inverse_relationship_*` (Patient perspective) |
| **Patient xem Caregiver** | Patient | Caregiver | `relationship_*` (Patient perspective) |

### Field Semantics

| Table/API | `relationship_*` Meaning | `inverse_relationship_*` Meaning |
|-----------|--------------------------|----------------------------------|
| `user_emergency_contacts` | Patient g·ªçi Caregiver l√† [X] | Caregiver g·ªçi Patient l√† [X] |
| `GET /connections` (monitoring) | Caregiver g·ªçi Patient l√† [X] | Patient g·ªçi Caregiver l√† [X] |
| `GET /connections` (monitored_by) | Patient g·ªçi Caregiver l√† [X] | Caregiver g·ªçi Patient l√† [X] |

---

## 3. Changes Required

### 3.1 Backend (Already Done)

**File:** `user-service/...ConnectionFlowService.java`

| Method | Change |
|--------|--------|
| `getViewingPatient()` | ‚úÖ Added `inverse_relationship_display` to SQL |
| `setViewingPatientByConnection()` | ‚úÖ Added `inverse_relationship_display` to SQL |
| `mapRowToViewingPatientInfo()` | ‚úÖ Map `inverse_relationship_display` field |
| `ViewingPatientInfo` DTO | ‚úÖ Added `inverseRelationshipDisplay` field |

### 3.2 Mobile App (Fixed v2.23)

| File | Change | Details |
|------|--------|---------|
| `ConnectionDetailScreen.tsx` | ‚úÖ Add `inverseRelationshipDisplay` param | Use for variant=monitoring |
| `ConnectRelativesScreen.tsx` | ‚úÖ Pass `inverse_relationship_display` | Navigate params |
| `ConnectRelativesScreen.tsx` | ‚úÖ AlertBlock uses `inverse_*` | patientName, relationshipDisplay |
| `ConnectRelativesScreen.tsx` | ‚úÖ HealthDashboard uses `inverse_*` fallback | relationship_name, relationship_display |
| `ProfileSelector.tsx` | ‚úÖ Use `inverse_relationship_display` | When selectedPatient exists |

---

## 4. API Response Updates

### GET /api/v1/connections/viewing

```json
{
  "viewing_patient": {
    "connection_id": "uuid",
    "patient_id": "uuid",
    "patient_name": "HuySau",
    "patient_avatar": "...",
    "patient_phone": "0912345678",
    "relationship_code": "chau",
    "relationship_name": "Ch√°u",
    "relationship_display": "Ch√°u (HuySau)",
    "inverse_relationship_code": "ong",
    "inverse_relationship_name": "√îng",
    "inverse_relationship_display": "√îng (HuySau)",  // v2.23 NEW
    "last_active": "2026-02-04T10:00:00Z"
  }
}
```

### GET /api/v1/connections

```json
{
  "monitoring": [
    {
      "connection_id": "uuid",
      "patient": { "id": "uuid", "name": "HuySau", "avatar": "..." },
      "relationship": "chau",
      "relationship_name": "Ch√°u",
      "relationship_display": "Ch√°u (HuySau)",
      "inverse_relationship": "ong",
      "inverse_relationship_name": "√îng",
      "inverse_relationship_display": "√îng (HuySau)",  // v2.22+ 
      "last_active": "..."
    }
  ]
}
```

---

## 5. Display Logic (Mobile v2.23)

### ConnectionDetailScreen

```typescript
// v2.23: For monitoring variant, use inverse_relationship_display (Patient perspective)
<CustomText style={styles.userRelation}>
  {variant === 'monitoring' && inverseRelationshipDisplay
    ? inverseRelationshipDisplay
    : getRelationshipName(relationship)}
</CustomText>
```

### AlertBlock / HealthDashboard

```typescript
// v2.23: Use inverse_relationship_* for Patient perspective
patientName={
  selectedPatient.inverse_relationship_name
    ? `${selectedPatient.inverse_relationship_name} (${selectedPatient.patient.name})`
    : selectedPatient.patient.name
}
relationshipDisplay={
  selectedPatient.inverse_relationship_display ||
  selectedPatient.relationship_display ||
  selectedPatient.patient.name
}
```

### ProfileSelector

```typescript
// v2.23: When viewing patient, use inverse_relationship_display
const displayName = selectedPatient?.inverse_relationship_display 
  ?? selectedPatient?.relationship_display 
  ?? `T√†i kho·∫£n c·ªßa ${userTitle?.toLowerCase()}`;
```

---

## 6. Impact Analysis

| Service | Impact | Status |
|---------|:------:|:------:|
| **user-service** | üü¢ LOW | ‚úÖ Complete |
| **api-gateway-service** | üü¢ LOW | ‚úÖ No change (just pass through) |
| **app-mobile-ai** | üü° MEDIUM | ‚úÖ Complete |

---

## 7. Test Cases

| Case | Before (Bug) | After (Fixed) |
|------|--------------|---------------|
| Caregiver click patient ‚Üí ConnectionDetail | "Ch√°u" | "√îng" |
| AlertBlock empty state | "Ch√°u (HuySau)" | "√îng (HuySau)" |
| HealthDashboard header | "Ch√°u" | "√îng" |
| ProfileSelector with patient | "Ch√°u (HuySau)" | "√îng (HuySau)" |

---

## 8. Related Documents

| Document | Version |
|----------|:-------:|
| `v2.18_inverse_relationship.md` | v2.18 |
| `04_mapping/api_mapping.md` | v2.23 |
| `ProfileSelector.tsx` | v2.23 |
| `ConnectionDetailScreen.tsx` | v2.23 |
| `ConnectRelativesScreen.tsx` | v2.23 |

---

## 9. Breaking Changes

**None.** All changes are backward compatible. `inverse_relationship_display` is optional and falls back to existing fields.
